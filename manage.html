<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Feeds - TBMCG News Dashboard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" type="image/svg+xml" href="/static/custom-logo.svg">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="/static/custom-logo.svg" alt="TBMCG Logo" class="nav-logo">
                <span class="nav-title">TBMCG News</span>
            </div>
            <div class="nav-links">
                <a href="/index.html" class="nav-link">
                    <span class="material-icons">dashboard</span>
                    Dashboard
                </a>
                <a href="/manage.html" class="nav-link active">
                    <span class="material-icons">settings</span>
                    Manage
                </a>
                <a href="#" class="nav-link" onclick="logout()">
                    <span class="material-icons">logout</span>
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Flash Messages Container -->
    <div class="flash-container" id="flashContainer"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="manage-container">
            <!-- Header -->
            <div class="manage-header">
                <h1>Manage RSS Feeds</h1>
                <p>Configure categories and RSS feed sources</p>
            </div>

            <!-- Management Sections -->
            <div class="manage-grid">
                <!-- Categories Section -->
                <div class="manage-section">
                    <div class="section-header">
                        <h2>Categories</h2>
                        <button class="btn btn-primary" onclick="showAddCategoryModal()">
                            <span class="material-icons">add</span>
                            Add Category
                        </button>
                    </div>
                    
                    <div class="categories-list" id="categoriesList">
                        <!-- Categories will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Feeds Section -->
                <div class="manage-section">
                    <div class="section-header">
                        <h2>RSS Feeds</h2>
                        <button class="btn btn-primary" onclick="showAddFeedModal()">
                            <span class="material-icons">add</span>
                            Add Feed
                        </button>
                    </div>
                    
                    <div class="feeds-list" id="feedsList">
                        <!-- Feeds will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Category Modal -->
    <div class="modal" id="addCategoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Category</h3>
                <button class="modal-close" onclick="closeModal('addCategoryModal')">&times;</button>
            </div>
            <form id="addCategoryForm">
                <div class="form-group">
                    <label for="categoryName">Category Name</label>
                    <input type="text" id="categoryName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="categoryDescription">Description (Optional)</label>
                    <textarea id="categoryDescription" name="description" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addCategoryModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Feed Modal -->
    <div class="modal" id="addFeedModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New RSS Feed</h3>
                <button class="modal-close" onclick="closeModal('addFeedModal')">&times;</button>
            </div>
            <form id="addFeedForm">
                <div class="form-group">
                    <label for="feedName">Feed Name</label>
                    <input type="text" id="feedName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="feedUrl">RSS Feed URL</label>
                    <input type="url" id="feedUrl" name="url" required>
                </div>
                <div class="form-group">
                    <label for="feedCategory">Category</label>
                    <select id="feedCategory" name="category_id" required>
                        <option value="">Select a category</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addFeedModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Feed</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        let categories = [];
        let feeds = [];

        // Initialize manage page
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAccess();
            loadCategories();
            setupForms();
        });

        // Check if user has admin access
        async function checkAdminAccess() {
            try {
                const response = await apiCall('/api/user');
                if (!response.user || response.user.role !== 'Admin') {
                    window.location.href = '/index.html';
                }
            } catch (error) {
                window.location.href = `${API_BASE_URL}/login`;
            }
        }

        // Load categories and feeds
        async function loadCategories() {
            try {
                toggleLoading(true);
                categories = await apiCall('/api/categories');
                await loadFeeds();
                displayCategories();
                displayFeeds();
                populateCategorySelect();
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Failed to load data. Please try again.', 'error');
            } finally {
                toggleLoading(false);
            }
        }

        async function loadFeeds() {
            try {
                feeds = await apiCall('/api/feeds');
            } catch (error) {
                console.error('Error loading feeds:', error);
                feeds = [];
            }
        }

        // Display categories
        function displayCategories() {
            const categoriesList = document.getElementById('categoriesList');
            
            if (categories.length === 0) {
                categoriesList.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons">folder_open</span>
                        <h3>No categories yet</h3>
                        <p>Create your first category to organize RSS feeds</p>
                    </div>
                `;
                return;
            }

            let categoriesHTML = '';
            categories.forEach(category => {
                const feedCount = feeds.filter(feed => feed.category_id === category.id).length;
                
                categoriesHTML += `
                    <div class="category-item-manage">
                        <div class="category-info">
                            <h4>${category.name}</h4>
                            <p>${category.description || 'No description'}</p>
                            <span class="category-stats">${feedCount} feeds</span>
                        </div>
                        <div class="category-actions">
                            <button class="btn btn-outline btn-sm" onclick="editCategory(${category.id})">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn btn-outline btn-sm btn-danger" onclick="deleteCategory(${category.id})">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            categoriesList.innerHTML = categoriesHTML;
        }

        // Display feeds
        function displayFeeds() {
            const feedsList = document.getElementById('feedsList');
            
            if (feeds.length === 0) {
                feedsList.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons">rss_feed</span>
                        <h3>No RSS feeds yet</h3>
                        <p>Add your first RSS feed to start collecting news</p>
                    </div>
                `;
                return;
            }

            let feedsHTML = '';
            feeds.forEach(feed => {
                const category = categories.find(cat => cat.id === feed.category_id);
                const statusClass = feed.enabled ? 'status-active' : 'status-inactive';
                const statusText = feed.enabled ? 'Active' : 'Inactive';
                
                feedsHTML += `
                    <div class="feed-item-manage">
                        <div class="feed-info">
                            <div class="feed-header">
                                <h4>${feed.name}</h4>
                                <span class="feed-status ${statusClass}">${statusText}</span>
                            </div>
                            <p class="feed-url">${feed.url}</p>
                            <p class="feed-description">${feed.description || 'No description'}</p>
                            <div class="feed-meta">
                                <span class="feed-category">${category ? category.name : 'No Category'}</span>
                                <span class="feed-updated">Updated: ${feed.last_updated ? formatDate(feed.last_updated) : 'Never'}</span>
                            </div>
                        </div>
                        <div class="feed-actions">
                            <button class="btn btn-outline btn-sm" onclick="toggleFeed(${feed.id}, ${!feed.enabled})">
                                <span class="material-icons">${feed.enabled ? 'pause' : 'play_arrow'}</span>
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="editFeed(${feed.id})">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn btn-outline btn-sm btn-danger" onclick="deleteFeed(${feed.id})">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            feedsList.innerHTML = feedsHTML;
        }

        // Populate category select
        function populateCategorySelect() {
            const select = document.getElementById('feedCategory');
            select.innerHTML = '<option value="">Select a category</option>';
            
            categories.forEach(category => {
                select.innerHTML += `<option value="${category.id}">${category.name}</option>`;
            });
        }

        // Modal functions
        function showAddCategoryModal() {
            document.getElementById('addCategoryModal').style.display = 'flex';
        }

        function showAddFeedModal() {
            document.getElementById('addFeedModal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Setup form handlers
        function setupForms() {
            document.getElementById('addCategoryForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const categoryData = {
                    name: formData.get('name'),
                    description: formData.get('description')
                };
                
                try {
                    await apiCall('/api/categories', {
                        method: 'POST',
                        body: JSON.stringify(categoryData)
                    });
                    
                    showNotification('Category added successfully!', 'success');
                    closeModal('addCategoryModal');
                    this.reset();
                    await loadCategories();
                } catch (error) {
                    console.error('Error adding category:', error);
                    showNotification('Failed to add category. Please try again.', 'error');
                }
            });

            document.getElementById('addFeedForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const feedData = {
                    name: formData.get('name'),
                    url: formData.get('url'),
                    category_id: parseInt(formData.get('category_id'))
                };
                
                try {
                    await apiCall('/api/feeds', {
                        method: 'POST',
                        body: JSON.stringify(feedData)
                    });
                    
                    showNotification('Feed added successfully!', 'success');
                    closeModal('addFeedModal');
                    this.reset();
                    await loadCategories();
                } catch (error) {
                    console.error('Error adding feed:', error);
                    showNotification('Failed to add feed. Please try again.', 'error');
                }
            });
        }

        // CRUD operations
        async function deleteCategory(categoryId) {
            if (!confirm('Are you sure you want to delete this category? This will also delete all associated feeds.')) {
                return;
            }
            
            try {
                await apiCall(`/api/categories/${categoryId}`, { method: 'DELETE' });
                showNotification('Category deleted successfully!', 'success');
                await loadCategories();
            } catch (error) {
                console.error('Error deleting category:', error);
                showNotification('Failed to delete category. Please try again.', 'error');
            }
        }

        async function deleteFeed(feedId) {
            if (!confirm('Are you sure you want to delete this feed?')) {
                return;
            }
            
            try {
                await apiCall(`/api/feeds/${feedId}`, { method: 'DELETE' });
                showNotification('Feed deleted successfully!', 'success');
                await loadCategories();
            } catch (error) {
                console.error('Error deleting feed:', error);
                showNotification('Failed to delete feed. Please try again.', 'error');
            }
        }

        async function toggleFeed(feedId, enabled) {
            try {
                await apiCall(`/api/feeds/${feedId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ enabled: enabled })
                });
                
                showNotification(`Feed ${enabled ? 'enabled' : 'disabled'} successfully!`, 'success');
                await loadCategories();
            } catch (error) {
                console.error('Error toggling feed:', error);
                showNotification('Failed to update feed. Please try again.', 'error');
            }
        }

        // Placeholder functions for edit operations
        function editCategory(categoryId) {
            showNotification('Edit category functionality coming soon!', 'info');
        }

        function editFeed(feedId) {
            showNotification('Edit feed functionality coming soon!', 'info');
        }

        // Logout function
        async function logout() {
            try {
                await apiCall('/logout', { method: 'POST' });
                window.location.href = `${API_BASE_URL}/login`;
            } catch (error) {
                window.location.href = `${API_BASE_URL}/login`;
            }
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>