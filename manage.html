<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Feeds - TBMCG News Dashboard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" type="image/svg+xml" href="/static/custom-logo.svg">
    <style>
        /* Hide everything initially until authentication is verified */
        body.auth-checking {
            visibility: hidden;
        }
        .auth-checking-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            visibility: visible;
            font-family: 'Inter', sans-serif;
            color: #666;
            display: none;
        }
        body.auth-checking .auth-checking-message {
            display: block;
        }
    </style>
</head>
<body class="auth-checking">
    <div class="auth-checking-message">Authenticating...</div>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="/static/custom-logo.svg" alt="TBMCG Logo" class="nav-logo">
                <span class="nav-title">TBMCG News</span>
            </div>
            <div class="nav-links">
                <a href="/index.html" class="nav-link">
                    <span class="material-icons">dashboard</span>
                    Dashboard
                </a>
                <a href="/manage.html" class="nav-link active">
                    <span class="material-icons">settings</span>
                    Manage
                </a>
                <a href="#" class="nav-link" onclick="logout()">
                    <span class="material-icons">logout</span>
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Flash Messages Container -->
    <div class="flash-container" id="flashContainer"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p>Loading...</p>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="manage-container">
            <!-- Header -->
            <div class="manage-header">
                <h1>Manage RSS Feeds</h1>
                <p>Configure categories and RSS feed sources</p>
            </div>

            <!-- Management Sections -->
            <div class="manage-grid">
                <!-- Categories Section -->
                <div class="manage-section">
                    <div class="section-header">
                        <h2>Categories</h2>
                        <button class="btn btn-primary" onclick="showAddCategoryModal()">
                            <span class="material-icons">add</span>
                            Add Category
                        </button>
                    </div>
                    
                    <div class="categories-list" id="categoriesList">
                        <!-- Categories will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Feeds Section -->
                <div class="manage-section">
                    <div class="section-header">
                        <h2>RSS Feeds</h2>
                        <button class="btn btn-primary" onclick="showAddFeedModal()">
                            <span class="material-icons">add</span>
                            Add Feed
                        </button>
                    </div>
                    
                    <div class="feeds-list" id="feedsList">
                        <!-- Feeds will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Category Modal -->
    <div class="modal" id="addCategoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Category</h3>
                <button class="modal-close" onclick="closeModal('addCategoryModal')">&times;</button>
            </div>
            <form id="addCategoryForm">
                <div class="form-group">
                    <label for="categoryName">Category Name</label>
                    <input type="text" id="categoryName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="categoryDescription">Description (Optional)</label>
                    <textarea id="categoryDescription" name="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="categoryColor">Category Color</label>
                    <div class="color-picker-container">
                        <div class="color-preview" id="colorPreview"></div>
                        <div class="color-swatches">
                            <div class="color-swatch" data-color="#6366f1" style="background-color: #6366f1;" title="Primary Blue"></div>
                            <div class="color-swatch" data-color="#0ea5e9" style="background-color: #0ea5e9;" title="Cyan"></div>
                            <div class="color-swatch" data-color="#10b981" style="background-color: #10b981;" title="Green"></div>
                            <div class="color-swatch" data-color="#f59e0b" style="background-color: #f59e0b;" title="Orange"></div>
                            <div class="color-swatch" data-color="#8b5cf6" style="background-color: #8b5cf6;" title="Purple"></div>
                            <div class="color-swatch" data-color="#ef4444" style="background-color: #ef4444;" title="Red"></div>
                            <div class="color-swatch" data-color="#3b82f6" style="background-color: #3b82f6;" title="Blue"></div>
                            <div class="color-swatch" data-color="#06b6d4" style="background-color: #06b6d4;" title="Teal"></div>
                            <div class="color-swatch" data-color="#84cc16" style="background-color: #84cc16;" title="Lime"></div>
                            <div class="color-swatch" data-color="#f97316" style="background-color: #f97316;" title="Orange Red"></div>
                            <div class="color-swatch" data-color="#ec4899" style="background-color: #ec4899;" title="Pink"></div>
                            <div class="color-swatch" data-color="#6b7280" style="background-color: #6b7280;" title="Gray"></div>
                        </div>
                        <div class="custom-color-input">
                            <input type="color" id="categoryColor" name="color" value="#6366f1">
                            <label for="categoryColor" class="custom-color-label">Custom Color</label>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addCategoryModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Feed Modal -->
    <div class="modal" id="addFeedModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New RSS Feed</h3>
                <button class="modal-close" onclick="closeModal('addFeedModal')">&times;</button>
            </div>
            <form id="addFeedForm">
                <div class="form-group">
                    <label for="feedName">Feed Name</label>
                    <input type="text" id="feedName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="feedUrl">RSS Feed URL</label>
                    <input type="url" id="feedUrl" name="url" required>
                </div>
                <div class="form-group">
                    <label for="feedCategory">Category</label>
                    <select id="feedCategory" name="category_id" required>
                        <option value="">Select a category</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addFeedModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Feed</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        let categories = [];
        let feeds = [];

        // Check auth and admin access immediately
        (async function checkAuthImmediately() {
            // Extract token from URL if present (after OAuth redirect)
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            if (token) {
                TokenManager.setToken(token);
                // Remove token from URL for security
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            // Check if we have a token at all
            if (!TokenManager.getToken()) {
                // No token, redirect immediately
                window.location.href = `${API_BASE_URL}/login`;
                return;
            }
            
            // Verify token is valid and user is admin
            try {
                const response = await apiCall('/api/user');
                if (!response.user) {
                    throw new Error('No user data');
                }
                
                // Check admin or editor access
                if (response.user.role !== 'Admin' && response.user.role !== 'Editor') {
                    window.location.href = '/index.html';
                    return;
                }
                
                // Authentication and authorization successful, show the page
                document.body.classList.remove('auth-checking');
                
                // Initialize manage page when DOM is ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        loadCategories();
                        setupForms();
                    });
                } else {
                    // DOM already loaded
                    loadCategories();
                    setupForms();
                }
            } catch (error) {
                // Invalid token or not authenticated
                TokenManager.removeToken();
                window.location.href = `${API_BASE_URL}/login`;
            }
        })()

        // Load categories and feeds
        async function loadCategories() {
            try {
                toggleLoading(true);
                categories = await apiCall('/api/categories');
                await loadFeeds();
                displayCategories();
                displayFeeds();
                populateCategorySelect();
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Failed to load data. Please try again.', 'error');
            } finally {
                toggleLoading(false);
            }
        }

        async function loadFeeds() {
            try {
                feeds = await apiCall('/api/feeds');
            } catch (error) {
                console.error('Error loading feeds:', error);
                feeds = [];
            }
        }

        // Display categories
        function displayCategories() {
            const categoriesList = document.getElementById('categoriesList');
            
            if (categories.length === 0) {
                categoriesList.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons">folder_open</span>
                        <h3>No categories yet</h3>
                        <p>Create your first category to organize RSS feeds</p>
                    </div>
                `;
                return;
            }

            let categoriesHTML = '';
            categories.forEach(category => {
                const feedCount = feeds.filter(feed => feed.category_id === category.id).length;
                
                categoriesHTML += `
                    <div class="category-item-manage">
                        <div class="category-info">
                            <h4>${category.name}</h4>
                            <p>${category.description || 'No description'}</p>
                            <span class="category-stats">${feedCount} feeds</span>
                        </div>
                        <div class="category-actions">
                            <button class="btn btn-outline btn-sm" onclick="editCategory(${category.id})">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn btn-outline btn-sm btn-danger" onclick="deleteCategory(${category.id})">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            categoriesList.innerHTML = categoriesHTML;
        }

        // Display feeds
        function displayFeeds() {
            const feedsList = document.getElementById('feedsList');
            
            if (feeds.length === 0) {
                feedsList.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons">rss_feed</span>
                        <h3>No RSS feeds yet</h3>
                        <p>Add your first RSS feed to start collecting news</p>
                    </div>
                `;
                return;
            }

            let feedsHTML = '';
            feeds.forEach(feed => {
                const category = categories.find(cat => cat.id === feed.category_id);
                const statusClass = feed.enabled ? 'status-active' : 'status-inactive';
                const statusText = feed.enabled ? 'Active' : 'Inactive';
                
                feedsHTML += `
                    <div class="feed-item-manage">
                        <div class="feed-info">
                            <div class="feed-header">
                                <h4>${feed.name}</h4>
                                <span class="feed-status ${statusClass}">${statusText}</span>
                            </div>
                            <p class="feed-url">${feed.url}</p>
                            <p class="feed-description">${feed.description || 'No description'}</p>
                            <div class="feed-meta">
                                <span class="feed-category">${category ? category.name : 'No Category'}</span>
                                <span class="feed-updated">Updated: ${feed.last_updated ? formatDate(feed.last_updated) : 'Never'}</span>
                            </div>
                        </div>
                        <div class="feed-actions">
                            <button class="btn btn-outline btn-sm" onclick="toggleFeed(${feed.id}, ${!feed.enabled})">
                                <span class="material-icons">${feed.enabled ? 'pause' : 'play_arrow'}</span>
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="editFeed(${feed.id})">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn btn-outline btn-sm btn-danger" onclick="deleteFeed(${feed.id})">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            feedsList.innerHTML = feedsHTML;
        }

        // Populate category select
        function populateCategorySelect() {
            const select = document.getElementById('feedCategory');
            select.innerHTML = '<option value="">Select a category</option>';
            
            categories.forEach(category => {
                select.innerHTML += `<option value="${category.id}">${category.name}</option>`;
            });
        }

        // Modal functions
        function showAddCategoryModal() {
            document.getElementById('addCategoryModal').style.display = 'flex';
            initializeColorPicker();
        }

        function showAddFeedModal() {
            document.getElementById('addFeedModal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            // Reset form and color picker when closing add category modal
            if (modalId === 'addCategoryModal') {
                document.getElementById('addCategoryForm').reset();
                initializeColorPicker();
            }
        }

        // Setup form handlers
        function setupForms() {
            document.getElementById('addCategoryForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const categoryData = {
                    name: formData.get('name'),
                    description: formData.get('description'),
                    color: formData.get('color')
                };
                
                try {
                    await apiCall('/api/categories', {
                        method: 'POST',
                        body: JSON.stringify(categoryData)
                    });
                    
                    showNotification('Category added successfully!', 'success');
                    closeModal('addCategoryModal');
                    this.reset();
                    await loadCategories();
                } catch (error) {
                    console.error('Error adding category:', error);
                    showNotification('Failed to add category. Please try again.', 'error');
                }
            });

            document.getElementById('addFeedForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const feedData = {
                    name: formData.get('name'),
                    url: formData.get('url'),
                    category_id: parseInt(formData.get('category_id'))
                };
                
                try {
                    await apiCall('/api/feeds', {
                        method: 'POST',
                        body: JSON.stringify(feedData)
                    });
                    
                    showNotification('Feed added successfully!', 'success');
                    closeModal('addFeedModal');
                    this.reset();
                    await loadCategories();
                } catch (error) {
                    console.error('Error adding feed:', error);
                    showNotification('Failed to add feed. Please try again.', 'error');
                }
            });
        }

        // CRUD operations
        async function deleteCategory(categoryId) {
            const category = categories.find(cat => cat.id === categoryId);
            const feedCount = feeds.filter(feed => feed.category_id === categoryId).length;
            
            let confirmMessage = `Are you sure you want to delete the category "${category.name}"?`;
            if (feedCount > 0) {
                confirmMessage = `This category contains ${feedCount} feed(s). You must delete or move these feeds before deleting the category. Would you like to view the feeds in this category?`;
                if (confirm(confirmMessage)) {
                    // Scroll to feeds section and highlight feeds in this category
                    document.getElementById('feedsList').scrollIntoView({ behavior: 'smooth' });
                    // Optionally filter feeds display to show only this category's feeds
                }
                return;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                await apiCall(`/api/categories/${categoryId}`, { method: 'DELETE' });
                showNotification('Category deleted successfully!', 'success');
                await loadCategories();
            } catch (error) {
                console.error('Error deleting category:', error);
                if (error.message && error.message.includes('feeds')) {
                    showNotification('Cannot delete category with existing feeds. Delete or move feeds first.', 'error');
                } else {
                    showNotification('Failed to delete category. Please try again.', 'error');
                }
            }
        }

        async function deleteFeed(feedId) {
            const feed = feeds.find(f => f.id === feedId);
            
            if (!confirm(`Are you sure you want to delete the feed "${feed.name}"?`)) {
                return;
            }
            
            try {
                await apiCall(`/api/feeds/${feedId}`, { method: 'DELETE' });
                showNotification('Feed deleted successfully!', 'success');
                await loadCategories();
            } catch (error) {
                console.error('Error deleting feed:', error);
                showNotification('Failed to delete feed. Please try again.', 'error');
            }
        }

        async function toggleFeed(feedId, enabled) {
            try {
                await apiCall(`/api/feeds/${feedId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ enabled: enabled })
                });
                
                showNotification(`Feed ${enabled ? 'enabled' : 'disabled'} successfully!`, 'success');
                await loadCategories();
            } catch (error) {
                console.error('Error toggling feed:', error);
                showNotification('Failed to update feed. Please try again.', 'error');
            }
        }

        // Color picker functionality
        function initializeColorPicker() {
            const colorPreview = document.getElementById('colorPreview');
            const colorInput = document.getElementById('categoryColor');
            const colorSwatches = document.querySelectorAll('.color-swatch');
            
            // Set default color
            const defaultColor = '#6366f1';
            colorInput.value = defaultColor;
            colorPreview.style.backgroundColor = defaultColor;
            
            // Mark default swatch as selected
            colorSwatches.forEach(swatch => {
                swatch.classList.remove('selected');
                if (swatch.dataset.color === defaultColor) {
                    swatch.classList.add('selected');
                }
            });
            
            // Handle swatch clicks
            colorSwatches.forEach(swatch => {
                swatch.addEventListener('click', function() {
                    const color = this.dataset.color;
                    selectColor(color);
                });
            });
            
            // Handle custom color input changes
            colorInput.addEventListener('input', function() {
                selectColor(this.value);
            });
            
            // Handle preview click to trigger custom color picker
            colorPreview.addEventListener('click', function() {
                colorInput.click();
            });
        }
        
        function selectColor(color) {
            const colorPreview = document.getElementById('colorPreview');
            const colorInput = document.getElementById('categoryColor');
            const colorSwatches = document.querySelectorAll('.color-swatch');
            
            // Update input and preview
            colorInput.value = color;
            colorPreview.style.backgroundColor = color;
            
            // Update swatch selection
            colorSwatches.forEach(swatch => {
                swatch.classList.remove('selected');
                if (swatch.dataset.color === color) {
                    swatch.classList.add('selected');
                }
            });
        }

        // Edit category function
        function editCategory(categoryId) {
            const category = categories.find(cat => cat.id === categoryId);
            if (!category) return;
            
            // Create edit modal if it doesn't exist
            let modal = document.getElementById('editCategoryModal');
            if (!modal) {
                modal = createEditCategoryModal();
                document.body.appendChild(modal);
            }
            
            // Populate form with category data
            document.getElementById('editCategoryId').value = category.id;
            document.getElementById('editCategoryName').value = category.name;
            document.getElementById('editCategoryDescription').value = category.description || '';
            document.getElementById('editCategoryColor').value = category.color || '#6366f1';
            
            // Initialize color picker for edit modal
            initializeEditColorPicker(category.color);
            
            // Show modal
            modal.style.display = 'flex';
        }

        function editFeed(feedId) {
            const feed = feeds.find(f => f.id === feedId);
            if (!feed) return;
            
            // Create edit modal if it doesn't exist
            let modal = document.getElementById('editFeedModal');
            if (!modal) {
                modal = createEditFeedModal();
                document.body.appendChild(modal);
            }
            
            // Populate form with feed data
            document.getElementById('editFeedId').value = feed.id;
            document.getElementById('editFeedName').value = feed.name;
            document.getElementById('editFeedUrl').value = feed.url;
            
            // Populate category dropdown
            const select = document.getElementById('editFeedCategory');
            select.innerHTML = '<option value="">Select a category</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                if (category.id === feed.category_id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // Show modal
            modal.style.display = 'flex';
        }
        
        // Create edit modals dynamically
        function createEditCategoryModal() {
            const modalHTML = `
                <div class="modal" id="editCategoryModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Edit Category</h3>
                            <button class="modal-close" onclick="closeModal('editCategoryModal')">&times;</button>
                        </div>
                        <form id="editCategoryForm">
                            <input type="hidden" id="editCategoryId" name="id">
                            <div class="form-group">
                                <label for="editCategoryName">Category Name</label>
                                <input type="text" id="editCategoryName" name="name" required>
                            </div>
                            <div class="form-group">
                                <label for="editCategoryDescription">Description (Optional)</label>
                                <textarea id="editCategoryDescription" name="description" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="editCategoryColor">Category Color</label>
                                <div class="color-picker-container">
                                    <div class="color-preview" id="editColorPreview"></div>
                                    <div class="color-swatches" id="editColorSwatches">
                                        <div class="color-swatch" data-color="#6366f1" style="background-color: #6366f1;" title="Primary Blue"></div>
                                        <div class="color-swatch" data-color="#0ea5e9" style="background-color: #0ea5e9;" title="Cyan"></div>
                                        <div class="color-swatch" data-color="#10b981" style="background-color: #10b981;" title="Green"></div>
                                        <div class="color-swatch" data-color="#f59e0b" style="background-color: #f59e0b;" title="Orange"></div>
                                        <div class="color-swatch" data-color="#8b5cf6" style="background-color: #8b5cf6;" title="Purple"></div>
                                        <div class="color-swatch" data-color="#ef4444" style="background-color: #ef4444;" title="Red"></div>
                                        <div class="color-swatch" data-color="#3b82f6" style="background-color: #3b82f6;" title="Blue"></div>
                                        <div class="color-swatch" data-color="#06b6d4" style="background-color: #06b6d4;" title="Teal"></div>
                                        <div class="color-swatch" data-color="#84cc16" style="background-color: #84cc16;" title="Lime"></div>
                                        <div class="color-swatch" data-color="#f97316" style="background-color: #f97316;" title="Orange Red"></div>
                                        <div class="color-swatch" data-color="#ec4899" style="background-color: #ec4899;" title="Pink"></div>
                                        <div class="color-swatch" data-color="#6b7280" style="background-color: #6b7280;" title="Gray"></div>
                                    </div>
                                    <div class="custom-color-input">
                                        <input type="color" id="editCategoryColor" name="color" value="#6366f1">
                                        <label for="editCategoryColor" class="custom-color-label">Custom Color</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-outline" onclick="closeModal('editCategoryModal')">Cancel</button>
                                <button type="submit" class="btn btn-primary">Update Category</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            const modal = modalDiv.firstElementChild;
            
            // Add form submit handler
            modal.querySelector('#editCategoryForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const categoryId = formData.get('id');
                const categoryData = {
                    name: formData.get('name'),
                    description: formData.get('description'),
                    color: formData.get('color')
                };
                
                try {
                    await apiCall(`/api/categories/${categoryId}`, {
                        method: 'PUT',
                        body: JSON.stringify(categoryData)
                    });
                    
                    showNotification('Category updated successfully!', 'success');
                    closeModal('editCategoryModal');
                    await loadCategories();
                } catch (error) {
                    console.error('Error updating category:', error);
                    showNotification('Failed to update category. Please try again.', 'error');
                }
            });
            
            return modal;
        }
        
        function createEditFeedModal() {
            const modalHTML = `
                <div class="modal" id="editFeedModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Edit RSS Feed</h3>
                            <button class="modal-close" onclick="closeModal('editFeedModal')">&times;</button>
                        </div>
                        <form id="editFeedForm">
                            <input type="hidden" id="editFeedId" name="id">
                            <div class="form-group">
                                <label for="editFeedName">Feed Name</label>
                                <input type="text" id="editFeedName" name="name" required>
                            </div>
                            <div class="form-group">
                                <label for="editFeedUrl">RSS Feed URL</label>
                                <input type="url" id="editFeedUrl" name="url" required>
                            </div>
                            <div class="form-group">
                                <label for="editFeedCategory">Category</label>
                                <select id="editFeedCategory" name="category_id" required>
                                    <option value="">Select a category</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-outline" onclick="closeModal('editFeedModal')">Cancel</button>
                                <button type="submit" class="btn btn-primary">Update Feed</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            const modal = modalDiv.firstElementChild;
            
            // Add form submit handler
            modal.querySelector('#editFeedForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const feedId = formData.get('id');
                const feedData = {
                    name: formData.get('name'),
                    url: formData.get('url'),
                    category_id: parseInt(formData.get('category_id'))
                };
                
                try {
                    await apiCall(`/api/feeds/${feedId}`, {
                        method: 'PUT',
                        body: JSON.stringify(feedData)
                    });
                    
                    showNotification('Feed updated successfully!', 'success');
                    closeModal('editFeedModal');
                    await loadCategories();
                } catch (error) {
                    console.error('Error updating feed:', error);
                    showNotification('Failed to update feed. Please try again.', 'error');
                }
            });
            
            return modal;
        }
        
        // Initialize color picker for edit modal
        function initializeEditColorPicker(currentColor) {
            const colorPreview = document.getElementById('editColorPreview');
            const colorInput = document.getElementById('editCategoryColor');
            const colorSwatches = document.querySelectorAll('#editColorSwatches .color-swatch');
            
            // Set current color
            colorInput.value = currentColor || '#6366f1';
            colorPreview.style.backgroundColor = currentColor || '#6366f1';
            
            // Mark current swatch as selected
            colorSwatches.forEach(swatch => {
                swatch.classList.remove('selected');
                if (swatch.dataset.color === currentColor) {
                    swatch.classList.add('selected');
                }
            });
            
            // Handle swatch clicks
            colorSwatches.forEach(swatch => {
                swatch.onclick = function() {
                    const color = this.dataset.color;
                    selectEditColor(color);
                };
            });
            
            // Handle custom color input changes
            colorInput.oninput = function() {
                selectEditColor(this.value);
            };
            
            // Handle preview click to trigger custom color picker
            colorPreview.onclick = function() {
                colorInput.click();
            };
        }
        
        function selectEditColor(color) {
            const colorPreview = document.getElementById('editColorPreview');
            const colorInput = document.getElementById('editCategoryColor');
            const colorSwatches = document.querySelectorAll('#editColorSwatches .color-swatch');
            
            // Update input and preview
            colorInput.value = color;
            colorPreview.style.backgroundColor = color;
            
            // Update swatch selection
            colorSwatches.forEach(swatch => {
                swatch.classList.remove('selected');
                if (swatch.dataset.color === color) {
                    swatch.classList.add('selected');
                }
            });
        }

        // Logout function
        async function logout() {
            try {
                await apiCall('/logout', { method: 'POST' });
                window.location.href = `${API_BASE_URL}/login`;
            } catch (error) {
                window.location.href = `${API_BASE_URL}/login`;
            }
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>